\chapter{测试与分析}\label{chap:result}

\section{最大工作频率分析}

本设计在分析 NVDLA 最大工作时钟时，选取了几个典型的时钟值，分别是 25 Mhz、50Mhz、75Mhz、100Mhz，他们的 Timing 报告如表~\ref{tab:25-100 Mhz Timing}所示，可以发现当时钟频率不断增加的时候，关键路径的 Slack 值不断在变小，影响 NVDLA 工作的主要问题是 Setup 时间不足，在 100Mhz 的时候已经不足 1 ns。

\begin{table}[!htbp]
    \caption{25 50 75 100 Mhz Timing报告}
    \label{tab:25-100 Mhz Timing}
    \centering
    \footnotesize% fontsize
    \setlength{\tabcolsep}{4pt}% column separation
    \renewcommand{\arraystretch}{1.2}%row space 
    \begin{tabular}{cccc}
        \toprule
        \multicolumn{1}{l}{\textbf{Frequency}} & \multicolumn{1}{l}{\textbf{Worst Setup Slack}} & \multicolumn{1}{l}{\textbf{Worst Hold Slack}} & \multicolumn{1}{l}{\textbf{Total Negative Slack}} \\
        \midrule
        25Mhz                                  & 29.048 ns                                      & 0.021 ns                                      & 0.000 ns                                          \\
        50Mhz                                  & 9.959 ns                                       & 0.007 ns                                      & 0.000 ns                                          \\
        75Mhz                                  & 3.832 ns                                       & 0.028 ns                                      & 0.000 ns                                          \\
        100Mhz                                 & 0.751 ns                                       & 0.030 ns                                      & 0.000 ns                                          \\
        \bottomrule                   
    \end{tabular}
\end{table}

如表~\ref{tab:150 Mhz Timing}所示，将时钟再提升至 150Mhz，则时钟已经出现了违例，具体表现为最差路径的 Slack 为负值，电路无法正常工作。如果此时强行上板会导致时序混乱，造成读写相关的寄存器失败。

由以上分析，在本设计中给 NVDLA 的输入时钟为 100Mhz，但是在 FPGA 上工作的最大时钟不代表进行 ASIC 设计能够工作的最大时钟，例如 Jetson Xavier NX 板卡上的 NVDLA 的工作时钟为 600 Mhz，根据中国科学院信息工程研究所的流片经验，其工作时钟为 800Mhz。

\begin{table}[!htbp]
    \caption{150 Mhz Timing报告}
    \label{tab:150 Mhz Timing}
    \centering
    \footnotesize% fontsize
    \setlength{\tabcolsep}{4pt}% column separation
    \renewcommand{\arraystretch}{1.2}%row space 
    \begin{tabular}{llll}
        \toprule
        \textbf{Frequency}         & \textbf{Worst Setup Slack}    & \textbf{Worst Hold Slack}    & \textbf{Total Negative Slack} \\
        \midrule
        \multicolumn{1}{c}{150Mhz} & \multicolumn{1}{c}{-0.324 ns} & \multicolumn{1}{c}{0.033 ns} & \multicolumn{1}{c}{-9.728 ns} \\
        \bottomrule                   
    \end{tabular}
\end{table}

如表~\ref{tab:25-100 Mhz Power}，本文还给出了 25Mhz、50Mhz、75Mhz、100Mhz 时钟下的功耗报告，当时钟频率增加的时候，系统的功耗不断增加，其中静态功耗占比较小，约为 10\%，动态功耗的占比较大，约为 90\%。

\begin{table}[!htbp]
    \caption{25 50 75 100 Mhz Power报告}
    \label{tab:25-100 Mhz Power}
    \centering
    \footnotesize% fontsize
    \setlength{\tabcolsep}{4pt}% column separation
    \renewcommand{\arraystretch}{1.2}%row space 
    \begin{tabular}{cccc}
        \toprule
        \multicolumn{1}{l}{\textbf{Frequency}} & \multicolumn{1}{l}{\textbf{Total Power}} & \multicolumn{1}{l}{\textbf{Static Power}} & \multicolumn{1}{l}{\textbf{Dynamic Power}} \\
        \midrule
        25 Mhz                                 & 1.921W                                   & 0.221W(11.5\%)                            & 1.700W(88.5\%)                             \\
        50 Mhz                                 & 2.129W                                   & 0.223W(10.5\%)                            & 1.906W(89.5\%)                             \\
        75 Mhz                                 & 2.325W                                   & 0.224W(9.6\%)                             & 2.101W(90.4\%)                             \\
        100 Mhz                                & 2.528W                                   & 0.226W(8.9\%)                             & 2.302W(91.9\%)                             \\
        \bottomrule                   
    \end{tabular}
\end{table}

\section{精度对比分析}

前文中提到，本设计基于 Caffe 框架自行训练了三个网络，其网络结构限于篇幅，全部的 prototxt 文件与 loadables 文件详见 Github\cite{nvdla_loadables}。

在这一小节，我们将 TensorRT 为了量化而采样的一千张图像再次使用 NVDLA 进行推理并验证精度是否存在损失。

\begin{table}[!htbp]
    \caption{精度对比}
    \label{tab:Qualifications Report}
    \centering
    \footnotesize% fontsize
    \setlength{\tabcolsep}{4pt}% column separation
    \renewcommand{\arraystretch}{1.2}%row space 
    \begin{tabular}{lccc}
        \toprule
        \textbf{Network}      & \multicolumn{1}{l}{\textbf{Valiadation Accuracy \%}} & \multicolumn{1}{l}{\textbf{Calibration Accuracy \%}}  & \multicolumn{1}{l}{\textbf{NVDLA Accuracy \%}} \\
        \midrule
        Lenet5-MNIST          & 99.7                                                 & 99.5                                                 & 97.5                                                 \\  
        Resnet18-CIFAR10      & 90.2                                                 & 86.7                                                 & 80.7                                                 \\
        Resnet18-IMAGENET2012 & 60.2(Top5)                                           & 50.5(Top5)                                           & 50.5(Top5)                                           \\
        \bottomrule                   
    \end{tabular}
\end{table}

其中，Resnet18-IMAGENET2012 网络参数较多，而本设计仅有 500MB 左右的片上存储，使得该网络无法在开发板卡上正常推理，精度的得出是使用的 QEMU 虚拟环境，经过 HPC 模拟硬件加速器调度得出。

理论上，NVDLA 的精度应该与 TensorRT 量化之后的精度一致，但是实际测试中，NVDLA的量化精度稍微低一些。经过分析，是因为 Caffe 训练的模型内部使用 OpenCV 进行图像读取操作，而 OpenCV 读取的图像为 BGR 格式，在 NVDLA 的 Runtime 阶段，由于 BGR 转 RGB 的操作会引发一系列错误，所以本设计将该操作去除，影响了部分精度，而 Resnet18-IMAGENET2012 未进行该处理，精度保持一致。

\section{推理速度分析}

硬件加速系统设计，我们往往关心其推理速度如何，如表~\ref{tab:Execution Time}所示，其中 Resnet18-IMAGENET2012 因为需要分配的内存过大，而无法在板卡上运行，所以本设计没有对运行速度进行评估，其余两个模型，分别推理了一千张图像观察推理的平均耗时。此外，为了对比 CPU 的运行时间，本设计还在 ARM A9 处理器上进行了 Caffe 框架的移植与编译，对预训练的 Caffemodel 进行 CPU 侧的推理，迭代五十次后取推理时间的平均值。

\begin{table}[!htbp]
    \caption{运行速度}
    \label{tab:Execution Time}
    \centering
    \footnotesize% fontsize
    \setlength{\tabcolsep}{4pt}% column separation
    \renewcommand{\arraystretch}{1.2}%row space 
    \begin{tabular}{lcccc}
        \toprule
        \textbf{Network}                                   & \multicolumn{1}{l}{\textbf{1000 Images Execution Time}} & \multicolumn{1}{l}{\textbf{Time Per Image}} & \textbf{FPS}     & \multicolumn{1}{l}{\textbf{Time ARM A9 (666 Mhz)}} \\
        \midrule
        \textbf{Lenet5-MNIST}          & 288129 ms                                               & 288.13 ms                                   & 3.47             & 23.55 ms                                            \\
        \textbf{Resnet18-CIFAR10}      & 287145 ms                                               & 287.15 ms                                   & 3.48             & 342.24 ms                                          \\
        \textbf{Resnet18-IMAGENET2012} & \textbackslash{}                                        & \textbackslash{}                            & \textbackslash{} & 6169.63 ms                                         \\
        \bottomrule                   
    \end{tabular}
\end{table}

虽然根据图表所示，对于 Lenet5，CPU 侧的推理仅需要 20ms，其速度比设计的硬件加速器还要快 10 倍，究其原因如下：

\begin{enumerate}
    \item CPU 是集成在 ZYNQ 器件上的硬核处理器，主频可达到 666 Mhz、而 NVDLA 因为其在 FPGA 上运行导致最高运行频率收到限制，仅可达到 100 Mhz。
    \item 对于 NVDLA，因其在 FPGA 上实现，所以功能验证正确是最主要的，对于运行速度需要通过 ASIC 流程得出，根据中国科学院自动化研究所的研究，在 600 Mhz 的工作频率下，Lenet5 的推理速度可以达到 0.2 ms \cite{9040769}。 
\end{enumerate}

其次，Resnet18-CIFAR10 在 CPU 侧推理的速度是 Lenet5 的 14.5 倍，可知其网络比 Lenet5 复杂许多，但是在 NVDLA 侧，推理速度仍然与 Lenet5 不相上下，说明在这两个网络的推理过程中，网络的复杂程度不是影响推理速度的关键因素，可能是访存等其他原因。